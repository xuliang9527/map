<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自定义颜色标点地图</title>
    <!-- 引入高德地图 JavaScript API -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=你的API_KEY"></script>
    <style>
        /* 设置地图容器的宽度和高度 */
        #map {
            width: 100%;
            height: 600px;
        }
        #adminLoginContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        #adminPasswordModal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        #adminPasswordModal input {
            padding: 10px;
            width: 200px;
            margin: 10px 0;
        }
        #adminPasswordModal button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #adminPasswordModal button:hover {
            background-color: #0056b3;
        }
        #colorPicker {
            margin: 10px;
        }
        #searchContainer {
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #searchInput {
            padding: 5px;
            font-size: 14px;
            width: 200px;
            margin-right: 10px;
        }
        #searchButton {
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #searchButton:hover {
            background-color: #0056b3;
        }
        .label-container {
            display: flex;
            flex-direction: column;
        }
        .label-container input {
            margin: 5px 0;
            padding: 5px;
            width: 250px;
        }
    </style>
</head>
<body>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 管理员登录入口 -->
    <div id="adminLoginContainer" onclick="showAdminLogin()">管理员登录</div>

    <!-- 管理员密码输入框 -->
    <div id="adminPasswordModal">
        <h3>请输入管理员密码</h3>
        <input type="password" id="passwordInput" placeholder="管理员密码" />
        <button onclick="login()">登录</button>
    </div>

    <div id="colorPickerContainer" style="display:none;">
        <label for="colorPicker">选择标点颜色:</label>
        <input type="color" id="colorPicker" value="#ff0000" />
    </div>

    <!-- 普通用户搜索框 -->
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="搜索标点标题..." onkeydown="checkEnter(event)" />
        <button id="searchButton" onclick="performSearch()">搜索</button>
    </div>

    <script>
        var markers = [];  // 用于保存标点对象，便于删除
        var map = new AMap.Map('map', {
            center: [116.397428, 39.90923], // 初始地图的中心位置（北京）
            zoom: 13 // 初始缩放级别
        });

        // 获取当前用户角色（管理员或普通用户）
        var currentUserRole = sessionStorage.getItem('userRole') || 'user'; // 默认普通用户

        // 显示管理员登录弹框
        function showAdminLogin() {
            document.getElementById('adminPasswordModal').style.display = 'block';
        }

        // 登录处理
        function login() {
            var password = document.getElementById('passwordInput').value;
            if (password === 'Urgo2024') {
                sessionStorage.setItem('userRole', 'admin');
                currentUserRole = 'admin';
                document.getElementById('adminPasswordModal').style.display = 'none';
                enableAdminFeatures();  // 激活管理员功能
            } else {
                alert("密码错误！");
            }
        }

        // 激活管理员功能
        function enableAdminFeatures() {
            document.getElementById('colorPickerContainer').style.display = 'block';
            alert('管理员登录成功！您现在可以添加标点和设置标签。');
        }

        // 创建自定义颜色标点
        function createCustomIcon(color) {
            var canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            var ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(16, 16, 14, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.stroke();
            var icon = new AMap.Icon({
                image: canvas.toDataURL(),
                size: new AMap.Size(32, 32)
            });
            return icon;
        }

        // 添加标点到地图
        function addMarker(lng, lat, color, title, description) {
            var icon = createCustomIcon(color);
            var marker = new AMap.Marker({
                position: new AMap.LngLat(lng, lat),
                title: title,
                icon: icon
            });

            // 给标点添加点击事件，显示自定义标签
            marker.on('click', function() {
                if (currentUserRole === 'admin') {
                    showLabel(marker, title, description);  // 仅管理员可以设置标签
                }
            });

            marker.setMap(map);  // 在地图上显示标点
            return marker;  // 返回标点对象，便于删除操作
        }

        // 显示自定义标签
        function showLabel(marker, title, description) {
            var content = `
                <div class="label-container">
                    <label for="titleInput">标题:</label>
                    <input type="text" id="titleInput" value="${title}" />
                    <label for="descriptionInput">描述:</label>
                    <input type="text" id="descriptionInput" value="${description}" />
                    <button onclick="saveLabel('${marker.getPosition().lng}', '${marker.getPosition().lat}')">保存</button>
                </div>
            `;
            var infoWindow = new AMap.InfoWindow({
                content: content,  // 使用自定义的HTML内容
                offset: new AMap.Pixel(0, -30)  // 调整标签的显示位置
            });
            infoWindow.open(map, marker.getPosition());  // 在标点位置打开标签
        }

        // 保存标签内容
        function saveLabel(lng, lat) {
            var title = document.getElementById('titleInput').value;
            var description = document.getElementById('descriptionInput').value;

            // 找到对应的标点并更新数据
            var marker = markers.find(m => m.getPosition().lng === parseFloat(lng) && m.getPosition().lat === parseFloat(lat));
            if (marker) {
                marker.setTitle(title);  // 更新标点的标题
                marker.setExtData({ description: description });  // 存储描述信息
            }

            // 更新 localStorage 数据
            saveMarkers();
        }

        // 保存标点信息到localStorage
        function saveMarkers() {
            var savedMarkers = markers.map(function(marker) {
                var position = marker.getPosition();
                var color = marker.getIcon().image.split('#')[1];  // 从图片的颜色值提取颜色
                var title = marker.getTitle();  // 获取标点的标题
                var description = marker.getExtData() ? marker.getExtData().description : '';  // 获取标点的描述
                return { lng: position.lng, lat: position.lat, color: `#${color}`, title: title, description: description };
            });
            localStorage.setItem('markers', JSON.stringify(savedMarkers));
        }

        // 点击地图时添加标点
        map.on('click', function(e) {
            if (currentUserRole === 'admin') { // 只有管理员可以添加标点
                var lngLat = e.lnglat;
                var lng = lngLat.lng;
                var lat = lngLat.lat;
                var color = document.getElementById('colorPicker').value;
                var title = prompt("请输入标点标题：", "默认标题");
                var description = prompt("请输入标点描述：", "默认描述");
                if (title && description) {
                    var marker = addMarker(lng, lat, color, title, description);  // 在地图上添加标点
                    markers.push(marker);  // 将标点保存到 markers 数组中
                    saveMarkers();  // 更新 localStorage 数据
                }
            } else {
                alert("你没有权限添加标点！");
            }
        });

        // 搜索功能：根据输入的标题进行完全匹配
        function searchMarkers(searchTerm) {
            var found = false;
            markers.forEach(function(marker) {
                if (marker.getTitle() === searchTerm) {
                    map.setCenter(marker.getPosition());  // 定位到该标点位置
                    map.setZoom(15);  // 放大地图
                    found = true;
                }
            });
            if (!found) {
                alert('未找到标点');
            }
        }

        // 监听回车键触发搜索
        function checkEnter(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        // 执行搜索
        function performSearch() {
            var searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm !== '') {
                searchMarkers(searchTerm);
            }
        }

        // 加载标点
        function loadMarkers() {
            var savedMarkers = JSON.parse(localStorage.getItem('markers')) || [];
            savedMarkers.forEach(function(markerData) {
                var marker = addMarker(markerData.lng, markerData.lat, markerData.color, markerData.title, markerData.description);
                markers.push(marker);
            });
        }

        // 加载标点
        loadMarkers();
    </script>

</body>
</html>
